Backport of:

From 76e1b96eb6b2a6eefd3f97cbf83679b1229047a3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Caol=C3=A1n=20McNamara?= <caolanm@redhat.com>
Date: Tue, 1 May 2018 12:57:02 +0100
Subject: set Referer on link mediadescriptor

to allow determining if the source document is from a trusted/untrusted
location

Reviewed-on: https://gerrit.libreoffice.org/53693
Tested-by: Jenkins <ci@libreoffice.org>
Reviewed-by: Stephan Bergmann <sbergman@redhat.com>
(cherry picked from commit cd25a97bbadc0a5c1fd6b0e8603c8b6ebd051926)

Change-Id: I780568652d2ef0cc8543c27ba26289277b5d9d0c
Reviewed-on: https://gerrit.libreoffice.org/53802
Tested-by: Jenkins <ci@libreoffice.org>
Reviewed-by: Christian Lohmaier <lohmaier+LibreOffice@googlemail.com>
---
 sw/source/filter/xml/xmltexti.cxx | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

Index: libreoffice-5.1.6~rc2/sw/source/filter/xml/xmltexti.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sw/source/filter/xml/xmltexti.cxx	2019-01-28 11:53:19.489533561 -0500
+++ libreoffice-5.1.6~rc2/sw/source/filter/xml/xmltexti.cxx	2019-01-28 11:55:07.365853561 -0500
@@ -574,17 +574,22 @@ uno::Reference< XPropertySet > SwXMLText
 
         uno::Sequence< beans::PropertyValue > aMediaDescriptor( 1 );
         aMediaDescriptor[0].Name = "URL";
-        aMediaDescriptor[0].Value <<= OUString( aURLObj.GetMainURL( INetURLObject::NO_DECODE ) );
-        if ( pDoc->GetDocShell() && pDoc->GetDocShell()->GetMedium() )
+        aMediaDescriptor[0].Value <<= aURLObj.GetMainURL( INetURLObject::NO_DECODE );
+
+        if (SfxMedium* pMedium = pDoc->GetDocShell() ? pDoc->GetDocShell()->GetMedium() : nullptr)
         {
-            uno::Reference< task::XInteractionHandler > xInteraction =
-                                        pDoc->GetDocShell()->GetMedium()->GetInteractionHandler();
+            uno::Reference< task::XInteractionHandler > xInteraction = pMedium->GetInteractionHandler();
             if ( xInteraction.is() )
             {
                 aMediaDescriptor.realloc( 2 );
                 aMediaDescriptor[1].Name = "InteractionHandler";
                 aMediaDescriptor[1].Value <<= xInteraction;
             }
+
+            const auto nLen = aMediaDescriptor.getLength() + 1;
+            aMediaDescriptor.realloc(nLen);
+            aMediaDescriptor[nLen - 1].Name = "Referer";
+            aMediaDescriptor[nLen - 1].Value <<= pMedium->GetName();
         }
 
         uno::Reference < embed::XEmbeddedObject > xObj(
