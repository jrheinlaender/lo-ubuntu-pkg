Backport of:

From 4ede45eb239b1604bca900c22481b7d13e4c2790 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Caol=C3=A1n=20McNamara?= <caolanm@redhat.com>
Date: Thu, 11 Jan 2018 14:16:15 +0000
Subject: Better handle ScDde formulas with missing dde-link entries
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

typically each ScDde formula has a matching table:dde-link which
results in a ScDdeLink getting inserted during the load. If that dde-link
is missing then no ScDdeLink exists and ScDde() will create a new one without
cached content. So detect that ScDde is used in the freshing loaded ods
and defer fetching new content until the right time.

only call GetHasMacroFunc to set SetHasMacroFunc

and bHasMacroFunc is not accessed any other way, so this is an oxbow

Change-Id: I016b53288076d83dd49e92e245346a5f7f560522
Reviewed-on: https://gerrit.libreoffice.org/47757
Tested-by: Jenkins <ci@libreoffice.org>
Reviewed-by: Caolán McNamara <caolanm@redhat.com>
Tested-by: Caolán McNamara <caolanm@redhat.com>
(cherry picked from commit b0597ba5d745974fce752e1b677451a19350d351)
Reviewed-on: https://gerrit.libreoffice.org/47818
Reviewed-by: Eike Rathke <erack@redhat.com>
---
 sc/inc/document.hxx                 | 6 +++---
 sc/qa/unit/ucalc.cxx                | 2 +-
 sc/source/core/data/documen2.cxx    | 2 +-
 sc/source/core/data/formulacell.cxx | 8 ++++----
 sc/source/core/tool/interpr2.cxx    | 8 +++++++-
 sc/source/ui/docshell/docsh4.cxx    | 2 ++
 sc/source/ui/view/tabvwsh4.cxx      | 2 +-
 7 files changed, 19 insertions(+), 11 deletions(-)

Index: libreoffice-5.1.6~rc2/sc/inc/document.hxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/inc/document.hxx	2018-02-12 15:34:28.843234082 -0500
+++ libreoffice-5.1.6~rc2/sc/inc/document.hxx	2018-02-12 15:34:28.835234095 -0500
@@ -437,7 +437,7 @@ private:
     // for detective update, is set for each change of a formula
     bool                bDetectiveDirty;
 
-    bool                bHasMacroFunc;      // valid only after loading
+    bool                bLinkFormulaNeedingCheck; // valid only after loading, for ocDde
 
     sal_uInt8               nAsianCompression;
     sal_uInt8               nAsianKerning;
@@ -1794,8 +1794,8 @@ public:
     bool            IsDetectiveDirty() const     { return bDetectiveDirty; }
     void            SetDetectiveDirty(bool bSet) { bDetectiveDirty = bSet; }
 
-    bool            GetHasMacroFunc() const      { return bHasMacroFunc; }
-    void            SetHasMacroFunc(bool bSet)   { bHasMacroFunc = bSet; }
+    bool            HasLinkFormulaNeedingCheck() const      { return bLinkFormulaNeedingCheck; }
+    void            SetLinkFormulaNeedingCheck(bool bSet)   { bLinkFormulaNeedingCheck = bSet; }
 
     static bool     CheckMacroWarn();
 
Index: libreoffice-5.1.6~rc2/sc/source/core/data/documen2.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/core/data/documen2.cxx	2018-02-12 15:34:28.843234082 -0500
+++ libreoffice-5.1.6~rc2/sc/source/core/data/documen2.cxx	2018-02-12 15:36:02.283088566 -0500
@@ -200,7 +200,7 @@ ScDocument::ScDocument( ScDocumentMode e
         bInDtorClear( false ),
         bExpandRefs( false ),
         bDetectiveDirty( false ),
-        bHasMacroFunc( false ),
+        bLinkFormulaNeedingCheck( false ),
         nAsianCompression(SC_ASIANCOMPRESSION_INVALID),
         nAsianKerning(SC_ASIANKERNING_INVALID),
         bPastingDrawFromOtherDoc( false ),
Index: libreoffice-5.1.6~rc2/sc/source/core/data/formulacell.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/core/data/formulacell.cxx	2018-02-12 15:34:28.843234082 -0500
+++ libreoffice-5.1.6~rc2/sc/source/core/data/formulacell.cxx	2018-02-12 15:34:28.839234090 -0500
@@ -1412,10 +1412,10 @@ void ScFormulaCell::CompileXML( sc::Comp
             bChanged = true;
     }
 
-    //  Same as in Load: after loading, it must be known if ocMacro is in any formula
-    //  (for macro warning, CompileXML is called at the end of loading XML file)
-    if ( !pDocument->GetHasMacroFunc() && pCode->HasOpCodeRPN( ocMacro ) )
-        pDocument->SetHasMacroFunc( true );
+    //  After loading, it must be known if ocDde is in any formula
+    //  (for external links warning, CompileXML is called at the end of loading XML file)
+    if (!pDocument->HasLinkFormulaNeedingCheck() && pCode->HasOpCodeRPN(ocDde))
+        pDocument->SetLinkFormulaNeedingCheck(true);
 
     //volatile cells must be added here for import
     if( pCode->IsRecalcModeAlways() || pCode->IsRecalcModeForced() ||
Index: libreoffice-5.1.6~rc2/sc/source/core/tool/interpr2.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/core/tool/interpr2.cxx	2018-02-12 15:34:28.843234082 -0500
+++ libreoffice-5.1.6~rc2/sc/source/core/tool/interpr2.cxx	2018-02-12 15:34:28.839234090 -0500
@@ -2483,8 +2483,14 @@ void ScInterpreter::ScDde()
                     pBindings->Invalidate( SID_LINKS );             // Link-Manager enablen
             }
 
+            //if the document was just loaded, but the ScDdeLink entry was missing, then
+            //don't update this link until the links are updated in response to the users
+            //decision
+            if (!pDok->HasLinkFormulaNeedingCheck())
+            {
                                     //TODO: evaluate asynchron ???
-            pLink->TryUpdate();     //  TryUpdate doesn't call Update multiple times
+                pLink->TryUpdate(); //  TryUpdate doesn't call Update multiple times
+            }
 
             if (pMyFormulaCell)
             {
Index: libreoffice-5.1.6~rc2/sc/source/ui/docshell/docsh4.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/ui/docshell/docsh4.cxx	2018-02-12 15:34:28.843234082 -0500
+++ libreoffice-5.1.6~rc2/sc/source/ui/docshell/docsh4.cxx	2018-02-12 15:34:28.839234090 -0500
@@ -477,6 +477,8 @@ void ScDocShell::Execute( SfxRequest& rR
                     rEmbeddedObjectContainer.setUserAllowsLinkUpdate(false);
                     rReq.Ignore();
                 }
+
+                rDoc.SetLinkFormulaNeedingCheck(false);
             }
             break;
 
Index: libreoffice-5.1.6~rc2/sc/source/ui/view/tabvwsh4.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/ui/view/tabvwsh4.cxx	2018-02-12 15:34:28.843234082 -0500
+++ libreoffice-5.1.6~rc2/sc/source/ui/view/tabvwsh4.cxx	2018-02-12 15:34:28.839234090 -0500
@@ -1564,7 +1564,7 @@ void ScTabViewShell::Construct( TriState
             if (!bLink)
             {
                 const sc::DocumentLinkManager& rMgr = rDoc.GetDocLinkManager();
-                if (rMgr.hasDdeOrOleLinks() || rDoc.HasAreaLinks())
+                if (rMgr.hasDdeOrOleLinks() || rDoc.HasAreaLinks() || rDoc.HasLinkFormulaNeedingCheck())
                     bLink = true;
             }
             if (bLink)
