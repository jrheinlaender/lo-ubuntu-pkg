From dc44111ad5965bf4179fc654b677e1e445dea2f0 Mon Sep 17 00:00:00 2001
From: Eike Rathke <erack@redhat.com>
Date: Thu, 25 Jan 2018 13:20:27 +0100
Subject: CheckLinkFormulaNeedingCheck() for conditional format expressions
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

 This is a combination of 4 commits.

Prepare CheckLinkFormulaNeedingCheck() to use either RPN or tokenized code

Conditional format formulas aren't finally compiled until needed
so the check will have to operate on the tokenized expression
instead of RPN code.

(cherry picked from commit faa0305ba3d0dc698fce4915d4f3a1fb52422380)

CheckLinkFormulaNeedingCheck() for .ods conditional format expressions

(cherry picked from commit 2930ba2ac5d9423f2848b968edcd8ddc71966186)

CheckLinkFormulaNeedingCheck() for .xlsx conditional format expressions

(cherry picked from commit fef24d9f999ee54d7936900485d97ff26656f517)

CheckLinkFormulaNeedingCheck() for .xls conditional format expressions

(cherry picked from commit af2a2a0c72db312902e466c36697b5c198041e82)

45eb1ab5efa0ec9da2663f20427d2474ce300826
31ede1a23223a798141a0891deeabd8cf88fff58
afa112cc591b411d80ead48bf726788d361f6eb3

Change-Id: I68837e9bd33f125ab47b10b1a6fa18175abd1627
Reviewed-on: https://gerrit.libreoffice.org/48719
Tested-by: Jenkins <ci@libreoffice.org>
Reviewed-by: Caolán McNamara <caolanm@redhat.com>
Tested-by: Caolán McNamara <caolanm@redhat.com>
---
 sc/source/core/data/conditio.cxx          |  6 ++++++
 sc/source/core/data/documen8.cxx          | 17 +++++++++++++++--
 sc/source/filter/excel/xicontent.cxx      |  6 ++++++
 sc/source/filter/oox/condformatbuffer.cxx |  2 ++
 4 files changed, 29 insertions(+), 2 deletions(-)

Index: libreoffice-5.1.6~rc2/sc/source/core/data/conditio.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/core/data/conditio.cxx	2018-02-12 15:41:02.722772097 -0500
+++ libreoffice-5.1.6~rc2/sc/source/core/data/conditio.cxx	2018-02-12 15:41:02.718772100 -0500
@@ -472,6 +472,12 @@ void ScConditionEntry::CompileXML()
     Compile( GetExpression(aSrcPos, 0, 0, eTempGrammar1),
              GetExpression(aSrcPos, 1, 0, eTempGrammar2),
              aStrNmsp1, aStrNmsp2, eTempGrammar1, eTempGrammar2, true );
+
+    // Importing ocDde/ocWebservice?
+    if (pFormula1)
+        mpDoc->CheckLinkFormulaNeedingCheck(*pFormula1);
+    if (pFormula2)
+        mpDoc->CheckLinkFormulaNeedingCheck(*pFormula2);
 }
 
 void ScConditionEntry::SetSrcString( const OUString& rNew )
Index: libreoffice-5.1.6~rc2/sc/source/core/data/documen8.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/core/data/documen8.cxx	2018-02-12 15:41:02.722772097 -0500
+++ libreoffice-5.1.6~rc2/sc/source/core/data/documen8.cxx	2018-02-12 15:41:02.718772100 -0500
@@ -1161,8 +1161,21 @@ void ScDocument::CheckLinkFormulaNeeding
     if (HasLinkFormulaNeedingCheck())
         return;
 
-    if (rCode.HasOpCodeRPN(ocDde) || rCode.HasOpCodeRPN(ocWebservice))
-        SetLinkFormulaNeedingCheck(true);
+    // Prefer RPN over tokenized formula if available.
+    if (rCode.GetCodeLen())
+    {
+        if (rCode.HasOpCodeRPN(ocDde) || rCode.HasOpCodeRPN(ocWebservice))
+            SetLinkFormulaNeedingCheck(true);
+    }
+    else if (rCode.GetLen())
+    {
+        if (rCode.HasOpCode(ocDde) || rCode.HasOpCode(ocWebservice))
+            SetLinkFormulaNeedingCheck(true);
+    }
+    else
+    {
+        assert(!"called with empty ScTokenArray");
+    }
 }
 
 // TimerDelays etc.
Index: libreoffice-5.1.6~rc2/sc/source/filter/excel/xicontent.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/filter/excel/xicontent.cxx	2018-02-12 15:41:02.722772097 -0500
+++ libreoffice-5.1.6~rc2/sc/source/filter/excel/xicontent.cxx	2018-02-12 15:41:02.718772100 -0500
@@ -656,7 +656,10 @@ void XclImpCondFormat::ReadCF( XclImpStr
         rFmlaConv.Convert( pTokArr, rStrm, nFmlaSize1, false, FT_CondFormat );
         // formula converter owns pTokArr -> create a copy of the token array
         if( pTokArr )
+        {
             xTokArr1.reset( pTokArr->Clone() );
+            GetDocRef().CheckLinkFormulaNeedingCheck( *xTokArr1);
+        }
     }
 
     ::std::unique_ptr< ScTokenArray > pTokArr2;
@@ -667,7 +670,10 @@ void XclImpCondFormat::ReadCF( XclImpStr
         rFmlaConv.Convert( pTokArr, rStrm, nFmlaSize2, false, FT_CondFormat );
         // formula converter owns pTokArr -> create a copy of the token array
         if( pTokArr )
+        {
             pTokArr2.reset( pTokArr->Clone() );
+            GetDocRef().CheckLinkFormulaNeedingCheck( *pTokArr2);
+        }
     }
 
     // *** create the Calc conditional formatting ***
Index: libreoffice-5.1.6~rc2/sc/source/filter/oox/condformatbuffer.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/filter/oox/condformatbuffer.cxx	2018-02-12 15:41:02.722772097 -0500
+++ libreoffice-5.1.6~rc2/sc/source/filter/oox/condformatbuffer.cxx	2018-02-12 15:41:02.718772100 -0500
@@ -867,11 +867,13 @@ void CondFormatRule::finalizeImport()
         {
             pTokenArray2.reset(new ScTokenArray());
             ScTokenConversion::ConvertToTokenArray( rDoc, *pTokenArray2.get(), maModel.maFormulas[ 1 ] );
+            rDoc.CheckLinkFormulaNeedingCheck( *pTokenArray2.get());
         }
 
         ScTokenArray aTokenArray;
         OUString aStyleName = getStyles().createDxfStyle( maModel.mnDxfId );
         ScTokenConversion::ConvertToTokenArray( rDoc, aTokenArray, maModel.maFormulas[ 0 ] );
+        rDoc.CheckLinkFormulaNeedingCheck( aTokenArray);
         ScCondFormatEntry* pNewEntry = new ScCondFormatEntry(eOperator,
                                             &aTokenArray, pTokenArray2.get(), &rDoc, aPos, aStyleName);
         mpFormat->AddEntry(pNewEntry);
