From 6a92ada1f624b3d37976845517595e15ed5a73f6 Mon Sep 17 00:00:00 2001
From: Martin Nathansen <marsianer@gmail.com>
Date: Mon, 18 Apr 2016 14:59:13 +0200
Subject: [PATCH] tdf#99371 fix for DDE link update via Function Wizard

With this fix the DDE links can be edited again without
producing additional wrong DDE links. However below
the updated DDE link there is still a unnecessary table
added which should be fixed.

Change-Id: I51e5a7ec84d2fc1429e68554dc131e4e456540df
Reviewed-on: https://gerrit.libreoffice.org/24213
Tested-by: Jenkins <ci@libreoffice.org>
Reviewed-by: Markus Mohrhard <markus.mohrhard@googlemail.com>
---
 sc/source/core/data/simpleformulacalc.cxx |  4 ++++
 sc/source/core/inc/interpre.hxx           |  5 +++++
 sc/source/core/tool/interpr2.cxx          | 12 ++++++------
 sc/source/core/tool/interpr4.cxx          |  1 +
 4 files changed, 16 insertions(+), 6 deletions(-)

Index: libreoffice-5.1.6~rc2/sc/source/core/data/simpleformulacalc.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/core/data/simpleformulacalc.cxx
+++ libreoffice-5.1.6~rc2/sc/source/core/data/simpleformulacalc.cxx
@@ -46,6 +46,10 @@ void ScSimpleFormulaCalculator::Calculat
 
     mbCalculated = true;
     ScInterpreter aInt(nullptr, mpDoc, maAddr, *mpCode.get());
+
+    std::unique_ptr<sfx2::LinkManager> pNewLinkMgr( new sfx2::LinkManager(mpDoc->GetDocumentShell()) );
+    aInt.SetLinkManager( pNewLinkMgr.get() );
+
     if (mbMatrixFormula)
         aInt.AssertFormulaMatrix();
 
Index: libreoffice-5.1.6~rc2/sc/source/core/inc/interpre.hxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/core/inc/interpre.hxx
+++ libreoffice-5.1.6~rc2/sc/source/core/inc/interpre.hxx
@@ -25,6 +25,7 @@
 #include <rtl/ustring.hxx>
 #include <formula/errorcodes.hxx>
 #include <formula/tokenarray.hxx>
+#include <sfx2/linkmgr.hxx>
 #include "scdll.hxx"
 #include "scdllapi.h"
 #include "types.hxx"
@@ -158,6 +159,7 @@ private:
     ScAddress   aPos;
     ScTokenArray& rArr;
     ScDocument* pDok;
+    sfx2::LinkManager* mpLinkManager;
     svl::SharedStringPool& mrStrPool;
     formula::FormulaTokenRef  xResult;
     ScJumpMatrix*   pJumpMatrix;        // currently active array condition, if any
@@ -900,6 +902,9 @@ public:
             { if (nError && !nGlobalError) nGlobalError = nError; }
     void AssertFormulaMatrix();
 
+    void SetLinkManager(sfx2::LinkManager* pLinkMgr)
+            { mpLinkManager = pLinkMgr; }
+
     sal_uInt16                  GetError() const            { return nGlobalError; }
     formula::StackVar           GetResultType() const       { return xResult->GetType(); }
     svl::SharedString GetStringResult() const;
Index: libreoffice-5.1.6~rc2/sc/source/core/tool/interpr2.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/core/tool/interpr2.cxx
+++ libreoffice-5.1.6~rc2/sc/source/core/tool/interpr2.cxx
@@ -2446,8 +2446,8 @@ void ScInterpreter::ScDde()
         //  temporary documents (ScFunctionAccess) have no DocShell
         //  and no LinkManager -> abort
 
-        sfx2::LinkManager* pLinkMgr = pDok->GetLinkManager();
-        if (!pLinkMgr)
+        //sfx2::LinkManager* pLinkMgr = pDok->GetLinkManager();
+        if (!mpLinkManager)
         {
             PushNoValue();
             return;
@@ -2465,7 +2465,7 @@ void ScInterpreter::ScDde()
 
             // Get/ Create link object
 
-        ScDdeLink* pLink = lcl_GetDdeLink( pLinkMgr, aAppl, aTopic, aItem, nMode );
+        ScDdeLink* pLink = lcl_GetDdeLink( mpLinkManager, aAppl, aTopic, aItem, nMode );
 
         //TODO: Save Dde-links (in addition) more efficient at document !!!!!
         //      ScDdeLink* pLink = pDok->GetDdeLink( aAppl, aTopic, aItem );
@@ -2475,8 +2475,8 @@ void ScInterpreter::ScDde()
         if (!pLink)
         {
             pLink = new ScDdeLink( pDok, aAppl, aTopic, aItem, nMode );
-            pLinkMgr->InsertDDELink( pLink, aAppl, aTopic, aItem );
-            if ( pLinkMgr->GetLinks().size() == 1 )                    // erster ?
+            mpLinkManager->InsertDDELink( pLink, aAppl, aTopic, aItem );
+            if ( mpLinkManager->GetLinks().size() == 1 )                    // erster ?
             {
                 SfxBindings* pBindings = pDok->GetViewBindings();
                 if (pBindings)
@@ -2530,7 +2530,7 @@ void ScInterpreter::ScDde()
             PushNA();
 
         pDok->EnableIdle(bOldEnabled);
-        pLinkMgr->CloseCachedComps();
+        mpLinkManager->CloseCachedComps();
     }
 }
 
Index: libreoffice-5.1.6~rc2/sc/source/core/tool/interpr4.cxx
===================================================================
--- libreoffice-5.1.6~rc2.orig/sc/source/core/tool/interpr4.cxx
+++ libreoffice-5.1.6~rc2/sc/source/core/tool/interpr4.cxx
@@ -3459,6 +3459,7 @@ ScInterpreter::ScInterpreter( ScFormulaC
     , aPos(rPos)
     , rArr(r)
     , pDok(pDoc)
+    , mpLinkManager(pDok->GetLinkManager())
     , mrStrPool(pDoc->GetSharedStringPool())
     , pJumpMatrix(nullptr)
     , pTokenMatrixMap(nullptr)
