From f6bcdc5ae6da9cb9b13bdc3551bef917d8b0362d Mon Sep 17 00:00:00 2001
From: Samuel Mehrbrodt <s.mehrbrodt@gmail.com>
Date: Thu, 27 Mar 2014 22:49:23 +0100
Subject: [PATCH] fdo-50672 Escape underscores in menus for unity
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Change-Id: Ibb4647c1ff6c2858fea888efae975e8e5c5011e2
Reviewed-on: https://gerrit.libreoffice.org/8773
Reviewed-by: Caolán McNamara <caolanm@redhat.com>
Tested-by: Caolán McNamara <caolanm@redhat.com>
---
 vcl/unx/gtk/window/gtksalmenu.cxx | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/vcl/unx/gtk/window/gtksalmenu.cxx b/vcl/unx/gtk/window/gtksalmenu.cxx
index 48dd225..d63fdd3 100644
--- a/vcl/unx/gtk/window/gtksalmenu.cxx
+++ b/vcl/unx/gtk/window/gtksalmenu.cxx
@@ -548,8 +548,10 @@ void GtkSalMenu::NativeSetEnableItem( gchar* aCommand, gboolean bEnable )
 void GtkSalMenu::NativeSetItemText( unsigned nSection, unsigned nItemPos, const OUString& rText )
 {
     SolarMutexGuard aGuard;
-    // Replace the '~' character with '_'.
-    OUString aText = rText.replace( '~', '_' );
+    // Escape all underscores so that they don't get interpreted as hotkeys
+    OUString aText = rText.replaceAll( "_", "__" );
+    // Replace the LibreOffice hotkey identifier with an underscore
+    aText = aText.replace( '~', '_' );
     OString aConvertedText = OUStringToOString( aText, RTL_TEXTENCODING_UTF8 );
 
     // Update item text only when necessary.
-- 
1.9.1

