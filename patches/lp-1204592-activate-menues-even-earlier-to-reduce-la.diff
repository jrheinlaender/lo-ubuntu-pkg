From 13badfb5ccd296faf480b19b2b33f7633f4085c5 Mon Sep 17 00:00:00 2001
From: Bjoern Michaelsen <bjoern.michaelsen@canonical.com>
Date: Thu, 5 Sep 2013 10:50:06 +0200
Subject: [PATCH] lp#1204592: activate menues even earlier to reduce latency
Forwarded: https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=13badfb5ccd296faf480b19b2b33f7633f4085c5;hp=43b84bbba2519686eb6b0463f422bf695d2d74b9

Change-Id: I54dc06c1bcd708fb666813ec2d0ca79acba361a0
---
 vcl/inc/unx/gtk/gtkframe.hxx          |  4 ++++
 vcl/unx/gtk/window/gloactiongroup.cxx |  8 ++++++++
 vcl/unx/gtk/window/gtksalframe.cxx    | 14 ++++++++++++++
 3 files changed, 26 insertions(+)

Index: libreoffice-4.1.4~rc2/vcl/inc/unx/gtk/gtkframe.hxx
===================================================================
--- libreoffice-4.1.4~rc2.orig/vcl/inc/unx/gtk/gtkframe.hxx	2013-12-16 14:35:37.334933608 +0100
+++ libreoffice-4.1.4~rc2/vcl/inc/unx/gtk/gtkframe.hxx	2013-12-16 14:35:37.322933609 +0100
@@ -219,6 +219,10 @@
     SalMenu*                        m_pSalMenu;
 
 #if defined(ENABLE_DBUS) && defined(ENABLE_GIO)
+    public:
+    void EnsureDbusMenuSynced();
+    private:
+    SalMenu*                        m_pLastSyncedDbusMenu;
     friend void ensure_dbus_setup(GdkWindow* gdkWindow, GtkSalFrame* pSalFrame);
     friend void on_registrar_available (GDBusConnection*, const gchar*, const gchar*, gpointer);
     friend void on_registrar_unavailable (GDBusConnection*, const gchar*, gpointer);
Index: libreoffice-4.1.4~rc2/vcl/unx/gtk/window/gloactiongroup.cxx
===================================================================
--- libreoffice-4.1.4~rc2.orig/vcl/unx/gtk/window/gloactiongroup.cxx	2013-12-16 14:35:37.334933608 +0100
+++ libreoffice-4.1.4~rc2/vcl/unx/gtk/window/gloactiongroup.cxx	2013-12-16 14:35:37.322933609 +0100
@@ -144,8 +144,15 @@
     if (action == NULL)
         return FALSE;
 
+
     if (enabled)
+    {
+        GtkSalFrame* pFrame = lo_group->priv->frame;
+        if (pFrame) {
+            pFrame->EnsureDbusMenuSynced();
+        }
         *enabled = action->enabled;
+    }
 
     if (parameter_type)
         *parameter_type = action->parameter_type;
@@ -193,6 +200,7 @@
                                 const gchar  *action_name,
                                 GVariant     *value)
 {
+    SAL_INFO("vcl.unity", "g_lo_action_group_change_state on " << group );
     g_return_if_fail (value != NULL);
 
     g_variant_ref_sink (value);
Index: libreoffice-4.1.4~rc2/vcl/unx/gtk/window/gtksalframe.cxx
===================================================================
--- libreoffice-4.1.4~rc2.orig/vcl/unx/gtk/window/gtksalframe.cxx	2013-12-16 14:35:37.334933608 +0100
+++ libreoffice-4.1.4~rc2/vcl/unx/gtk/window/gtksalframe.cxx	2013-12-16 14:35:37.326933609 +0100
@@ -505,6 +505,9 @@
     GetGenericData()->ErrorTrapPush();
     m_bDefaultPos       = true;
     m_bDefaultSize      = true;
+#if defined(ENABLE_DBUS) && defined(ENABLE_GIO)
+    m_pLastSyncedDbusMenu = NULL;
+#endif
     Init( pSysData );
 }
 
@@ -544,6 +547,17 @@
     }
 }
 
+#if defined(ENABLE_DBUS) && defined(ENABLE_GIO)
+void GtkSalFrame::EnsureDbusMenuSynced()
+{
+    GtkSalMenu* pSalMenu = static_cast<GtkSalMenu*>(GetMenu());
+    if(m_pLastSyncedDbusMenu != pSalMenu) {
+        m_pLastSyncedDbusMenu = pSalMenu;
+        static_cast<GtkSalMenu*>(pSalMenu)->Activate();
+    }
+}
+#endif
+
 static void hud_activated( gboolean hud_active, gpointer user_data )
 {
     if ( hud_active )
